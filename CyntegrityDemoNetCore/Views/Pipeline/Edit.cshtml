@model CyntegrityDemoNetCore.Models.PipelineEditViewModel
@{
    ViewData["Title"] = "Edit pipeline";
}

@section Scripts {
    <partial name="~/Views/Shared/_ValidationScriptsPartial.cshtml" />
    <script>
        $(function () {
            $.ajaxSetup({
                beforeSend: request => {
                    token = $('input[name="__RequestVerificationToken"]').val()
                    request.setRequestHeader("RequestVerificationToken", token);
                }
            })

            $('#form').validate({
                rules: {
                    name: 'required'
                },
                messages: {
                    name: 'Name is required'
                },
                submitHandler: form => {
                    savePipeline()
                }
            });

            var pipeline = @Html.Raw(Json.Serialize(Model.Pipeline))
            pipeline.id = @Html.Raw(Json.Serialize(Model.Pipeline.Id.ToString()))
            pipeline.taskIds = @Html.Raw(Json.Serialize(Model.Pipeline.TaskIds.Select(x => x.ToString())))
            
            let onClickToAddButton = function () {
                let taskId = $(this).siblings('input[name="_id"]').val()

                if (pipeline.taskIds.indexOf(taskId) < 0) {
                    pipeline.taskIds.push(taskId)
                    addTaskToPipeline(taskId)
                }
            }
            let addTaskToPipeline = function (taskId) {
                let addButton = $('input[value=' + taskId + ']').siblings('.btn-add')
                addButton.hide()

                let newElement = $(addButton).parent().clone()
                newElement.addClass('task-in-pipeline')
                newElement.addClass(taskId)
                $('.tasks-in-pipeline').append(newElement)

                let $removeButton = $('<button class="btn btn-primary btn-remove" type="button">Remove</button>')
                $removeButton.click(removeTaskFromPipeline)
                $('.' + taskId).append($removeButton)

                $(addButton).addClass(taskId)
                $(addButton).addClass('hided')
            }
            let removeTaskFromPipeline = function () {
                let taskId = $(this).siblings('input[name="_id"]').val()

                let index = pipeline.taskIds.indexOf(taskId)
                if (index >= 0) {
                    pipeline.taskIds.splice(index, 1)

                    let $addButton = $('.hided').filter('.' + taskId)
                    $addButton.show()

                    $addButton.removeClass(taskId)
                    $addButton.removeClass('hided')


                    $(this).parent().remove()
                }
            }
            let savePipeline = function () {
                let url = '/Pipeline/' + pipeline.id
                let editUrl = '/Pipeline/' + pipeline.id + '/Edit'

                $.post({
                    url: editUrl,
                    data: pipeline
                })
                    .done(function () {
                        console.log(pipeline.id)
                        window.location.pathname = url
                    })
                    .fail(function (error) {
                        if (error.status === 200 && error.statusText === 'OK')
                            window.location.pathname = url
                    })
            }

            pipeline.taskIds.forEach(taskId => addTaskToPipeline(taskId));

            $(document).on('click', '.btn-add', onClickToAddButton)

            $('#name').val(pipeline.name)
            $(document).on('input', '#name', function () {
                pipeline.name = $(this).val()
            })
        })
    </script>
}

<div class="text-center">
    <h1 class="display-4">Edit @Model.Pipeline.Name</h1>

    <br />

    <partial name="~/Views/Shared/_PipelinePartial.cshtml" />
</div>
